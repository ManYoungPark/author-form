<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>저자 정보 입력</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { max-width: 600px; margin: auto; border: 1px solid #ccc; padding: 20px; border-radius: 10px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 5px; }
    #signature { border: 2px solid #333; border-radius: 8px; width: 100%; height: 200px; margin-top: 10px; touch-action: none; }
    button { margin: 10px 5px 0 0; padding: 10px 20px; font-size: 14px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    img { max-height: 80px; }
    .delete-box { margin-top: 20px; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">저자 정보 입력 + 서명필요 </h2>

  <form>
     <label>이름(한글)</label>
    <input type="text" id="name_kr" required>
    <label>이름(영문)</label>
    <input type="text" id="name_en" required>
    <label>소속(한글)</label>
    <input type="text" id="affiliation_kr" required>
    <label>소속(영문)</label>
    <input type="text" id="affiliation_en" required>
    <label>ORCID</label>
    <input type="text" id="orcid">
    <label>이메일</label>
    <input type="email" id="email" required>

    <label>서명 (캔버스 또는 파일 업로드)</label>
    <canvas id="signature"></canvas><br>
    <input type="file" id="signature_file" accept="image/*"><br>
    <button type="button" onclick="clearPad()">서명 지우기</button>
    <button type="button" onclick="submitData()">제출하기</button>
  </form>

  <div id="authorList"></div>

  <!-- ✅ 삭제 기능 영역 -->
  <div class="delete-box">
    <input type="password" id="delete_pw" placeholder="비밀번호 입력">
    <button onclick="deleteSelected()">선택 삭제</button>
  </div>

  <script>
    const SUPABASE_URL = "https://lkltfigaylemgsehkkdg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrbHRmaWdheWxlbWdzZWhra2RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDM2NzksImV4cCI6MjA3MzU3OTY3OX0.75jPhekoPJfsoeaTPSApbGVhq75ObzdYvYAXT_CBUak";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const canvas = document.getElementById("signature");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // 🖱️ 마우스
    canvas.addEventListener("mousedown", (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    canvas.addEventListener("mousemove", (e) => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseout", () => drawing = false);

    // 📱 터치
    function getTouchPos(e) {
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      return { x: touch.pageX - rect.left, y: touch.pageY - rect.top };
    }
    canvas.addEventListener("touchstart", (e) => { e.preventDefault(); drawing = true; const pos = getTouchPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); });
    canvas.addEventListener("touchmove", (e) => { e.preventDefault(); if (drawing) { const pos = getTouchPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } });
    canvas.addEventListener("touchend", () => drawing = false);

    function clearPad() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    async function submitData() {
      const name_kr = document.getElementById("name_kr").value.trim();
      const name_en = document.getElementById("name_en").value.trim();
      const affiliation_kr = document.getElementById("affiliation_kr").value.trim();
      const affiliation_en = document.getElementById("affiliation_en").value.trim();
      const orcid = document.getElementById("orcid").value.trim();
      const email = document.getElementById("email").value.trim();
      const fileInput = document.getElementById("signature_file");

      if (!name_kr || !name_en || !affiliation_kr || !affiliation_en || !email) {
        alert("필수 항목을 모두 입력하세요.");
        return;
      }

      let blob, fileName;
      if (fileInput.files.length > 0) {
        blob = fileInput.files[0];
        fileName = `${name_en.replace(/\s+/g, "_")}_${Date.now()}.png`;
      } else {
        const signatureData = canvas.toDataURL("image/png");
        blob = await (await fetch(signatureData)).blob();
        fileName = `${name_en.replace(/\s+/g, "_")}_${Date.now()}.png`;
      }

      const { error: storageError } = await supabase
        .storage.from("signatures")
        .upload(fileName, blob, { upsert: true });

      if (storageError) {
        alert("서명 업로드 오류: " + storageError.message);
        return;
      }

      const signature_url = `${SUPABASE_URL}/storage/v1/object/public/signatures/${fileName}`;

      const { error } = await supabase
        .from("authors")
        .insert([{ name_kr, name_en, affiliation_kr, affiliation_en, orcid, email, signature_url }]);

      if (error) {
        alert("DB 저장 오류: " + error.message);
      } else {
        alert("저장 성공! 🎉");
        clearPad();
        fileInput.value = "";
        loadAuthors();
      }
    }

    async function loadAuthors() {
      const { data, error } = await supabase.from("authors").select("*").order("id", { ascending: false });
      if (error) {
        document.getElementById("authorList").innerHTML = "데이터 불러오기 오류: " + error.message;
        return;
      }
      if (!data || data.length === 0) {
        document.getElementById("authorList").innerHTML = "<p>아직 입력된 데이터가 없습니다.</p>";
        return;
      }

      let html = "<h3>이미 제출한 저자 목록</h3><table><tr><th>선택</th><th>이름(한글)</th><th>이름(영문)</th><th>소속(한글)</th><th>소속(영문)</th><th>ORCID</th><th>이메일</th><th>서명</th></tr>";
      data.forEach(row => {
        html += `<tr>
          <td><input type="checkbox" class="delete-check" value="${row.id}"></td>
          <td>${row.name_kr}</td>
          <td>${row.name_en}</td>
          <td>${row.affiliation_kr}</td>
          <td>${row.affiliation_en}</td>
          <td>${row.orcid || ""}</td>
          <td>${row.email}</td>
          <td><img src="${row.signature_url}" alt="signature"></td>
        </tr>`;
      });
      html += "</table>";

      document.getElementById("authorList").innerHTML = html;
    }

    async function deleteSelected() {
      const pw = document.getElementById("delete_pw").value;
      if (pw !== "1111") {
        alert("비밀번호가 올바르지 않습니다.");
        return;
      }

      const checkboxes = document.querySelectorAll(".delete-check:checked");
      if (checkboxes.length === 0) {
        alert("삭제할 항목을 선택하세요.");
        return;
      }

      const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

      const { error } = await supabase.from("authors").delete().in("id", ids);

      if (error) {
        alert("삭제 오류: " + error.message);
      } else {
        alert("선택한 항목 삭제 완료");
        loadAuthors();
      }
    }

    window.onload = loadAuthors;
  </script>
</body>
</html>





