<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>저자 정보 입력 + 서명 (Supabase)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { max-width: 600px; margin: auto; border: 1px solid #ccc; padding: 20px; border-radius: 10px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 5px; }
    #signature { border: 2px solid #333; border-radius: 8px; width: 100%; height: 200px; margin-top: 10px; }
    button { margin: 10px 5px 0 0; padding: 10px 20px; font-size: 14px; cursor: pointer; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">저자 정보 입력 + 서명 (Supabase 저장)</h2>

  <form>
    <label>이름(한글)</label>
    <input type="text" id="name_kr" required>
    <label>이름(영문)</label>
    <input type="text" id="name_en" required>
    <label>소속(한글)</label>
    <input type="text" id="affiliation_kr" required>
    <label>소속(영문)</label>
    <input type="text" id="affiliation_en" required>
    <label>ORCID</label>
    <input type="text" id="orcid">
    <label>이메일</label>
    <input type="email" id="email" required>

    <label>서명</label>
    <canvas id="signature"></canvas><br>
    <button type="button" onclick="clearPad()">서명 지우기</button>
    <button type="button" onclick="submitData()">제출하기</button>
  </form>

  <script>
    // ✅ 본인 Supabase 프로젝트 정보
    const SUPABASE_URL = "https://lkltfigaylemgsehkkdg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrbHRmaWdheWxlbWdzZWhra2RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDM2NzksImV4cCI6MjA3MzU3OTY3OX0.75jPhekoPJfsoeaTPSApbGVhq75ObzdYvYAXT_CBUak";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ✅ 캔버스 초기화
    const canvas = document.getElementById("signature");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // 🖱️ 마우스 이벤트
    canvas.addEventListener("mousedown", (e) => {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });
    canvas.addEventListener("mousemove", (e) => {
      if (drawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    });
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseout", () => drawing = false);

    // 📱 모바일 터치 이벤트 (개선된 버전)
    function getTouchPos(e) {
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      return {
        x: touch.pageX - rect.left,
        y: touch.pageY - rect.top
      };
    }

    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      drawing = true;
      const pos = getTouchPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    });

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      if (drawing) {
        const pos = getTouchPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      }
    });

    canvas.addEventListener("touchend", () => drawing = false);

    function clearPad() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    async function submitData() {
      const name_kr = document.getElementById("name_kr").value.trim();
      const name_en = document.getElementById("name_en").value.trim();
      const affiliation_kr = document.getElementById("affiliation_kr").value.trim();
      const affiliation_en = document.getElementById("affiliation_en").value.trim();
      const orcid = document.getElementById("orcid").value.trim();
      const email = document.getElementById("email").value.trim();

      if (!name_kr || !name_en || !affiliation_kr || !affiliation_en || !email) {
        alert("필수 항목을 모두 입력하세요.");
        return;
      }

      // ✅ 1) 캔버스 → Blob 변환
      const signatureData = canvas.toDataURL("image/png");
      const blob = await (await fetch(signatureData)).blob();
      const fileName = `${name_kr}_${Date.now()}.png`;

      // ✅ 2) Supabase Storage에 이미지 저장
      const { data: storageData, error: storageError } = await supabase
        .storage.from("signatures")
        .upload(fileName, blob, { upsert: true });

      if (storageError) {
        alert("서명 업로드 오류: " + storageError.message);
        return;
      }

      // public URL
      const signature_url = `${SUPABASE_URL}/storage/v1/object/public/signatures/${fileName}`;

      // ✅ 3) authors 테이블에 정보 + signature_url 저장
      const { error } = await supabase
        .from("authors")
        .insert([{
          name_kr, name_en,
          affiliation_kr, affiliation_en,
          orcid, email,
          signature_url
        }]);

      if (error) {
        alert("DB 저장 오류: " + error.message);
      } else {
        alert("저장 성공! 🎉");
        clearPad();
      }
    }
  </script>
</body>
</html>
