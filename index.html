<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì €ì ì •ë³´ ì…ë ¥</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { max-width: 600px; margin: auto; border: 1px solid #ccc; padding: 20px; border-radius: 10px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 5px; }
    #signature { border: 2px solid #333; border-radius: 8px; width: 100%; height: 200px; margin-top: 10px; touch-action: none; }
    button { margin: 10px 5px 0 0; padding: 10px 20px; font-size: 14px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    img { max-height: 80px; }
    .delete-box { margin-top: 20px; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">ì €ì ì •ë³´ ì…ë ¥ + ì„œëª…í•„ìš” </h2>

  <form>
     <label>ì´ë¦„(í•œê¸€)</label>
    <input type="text" id="name_kr" required>
    <label>ì´ë¦„(ì˜ë¬¸)</label>
    <input type="text" id="name_en" required>
    <label>ì†Œì†(í•œê¸€)</label>
    <input type="text" id="affiliation_kr" required>
    <label>ì†Œì†(ì˜ë¬¸)</label>
    <input type="text" id="affiliation_en" required>
    <label>ORCID</label>
    <input type="text" id="orcid">
    <label>ì´ë©”ì¼</label>
    <input type="email" id="email" required>

    <label>ì„œëª… (ìº”ë²„ìŠ¤ ë˜ëŠ” íŒŒì¼ ì—…ë¡œë“œ)</label>
    <canvas id="signature"></canvas><br>
    <input type="file" id="signature_file" accept="image/*"><br>
    <button type="button" onclick="clearPad()">ì„œëª… ì§€ìš°ê¸°</button>
    <button type="button" onclick="submitData()">ì œì¶œí•˜ê¸°</button>
  </form>

  <div id="authorList"></div>

  <!-- âœ… ì‚­ì œ ê¸°ëŠ¥ ì˜ì—­ -->
  <div class="delete-box">
    <input type="password" id="delete_pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <button onclick="deleteSelected()">ì„ íƒ ì‚­ì œ</button>
  </div>

  <script>
    const SUPABASE_URL = "https://lkltfigaylemgsehkkdg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrbHRmaWdheWxlbWdzZWhra2RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDM2NzksImV4cCI6MjA3MzU3OTY3OX0.75jPhekoPJfsoeaTPSApbGVhq75ObzdYvYAXT_CBUak";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const canvas = document.getElementById("signature");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // ğŸ–±ï¸ ë§ˆìš°ìŠ¤
    canvas.addEventListener("mousedown", (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    canvas.addEventListener("mousemove", (e) => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseout", () => drawing = false);

    // ğŸ“± í„°ì¹˜
    function getTouchPos(e) {
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      return { x: touch.pageX - rect.left, y: touch.pageY - rect.top };
    }
    canvas.addEventListener("touchstart", (e) => { e.preventDefault(); drawing = true; const pos = getTouchPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); });
    canvas.addEventListener("touchmove", (e) => { e.preventDefault(); if (drawing) { const pos = getTouchPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } });
    canvas.addEventListener("touchend", () => drawing = false);

    function clearPad() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    async function submitData() {
      const name_kr = document.getElementById("name_kr").value.trim();
      const name_en = document.getElementById("name_en").value.trim();
      const affiliation_kr = document.getElementById("affiliation_kr").value.trim();
      const affiliation_en = document.getElementById("affiliation_en").value.trim();
      const orcid = document.getElementById("orcid").value.trim();
      const email = document.getElementById("email").value.trim();
      const fileInput = document.getElementById("signature_file");

      if (!name_kr || !name_en || !affiliation_kr || !affiliation_en || !email) {
        alert("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      let blob, fileName;
      if (fileInput.files.length > 0) {
        blob = fileInput.files[0];
        fileName = `${name_en.replace(/\s+/g, "_")}_${Date.now()}.png`;
      } else {
        const signatureData = canvas.toDataURL("image/png");
        blob = await (await fetch(signatureData)).blob();
        fileName = `${name_en.replace(/\s+/g, "_")}_${Date.now()}.png`;
      }

      const { error: storageError } = await supabase
        .storage.from("signatures")
        .upload(fileName, blob, { upsert: true });

      if (storageError) {
        alert("ì„œëª… ì—…ë¡œë“œ ì˜¤ë¥˜: " + storageError.message);
        return;
      }

      const signature_url = `${SUPABASE_URL}/storage/v1/object/public/signatures/${fileName}`;

      const { error } = await supabase
        .from("authors")
        .insert([{ name_kr, name_en, affiliation_kr, affiliation_en, orcid, email, signature_url }]);

      if (error) {
        alert("DB ì €ì¥ ì˜¤ë¥˜: " + error.message);
      } else {
        alert("ì €ì¥ ì„±ê³µ! ğŸ‰");
        clearPad();
        fileInput.value = "";
        loadAuthors();
      }
    }

    async function loadAuthors() {
      const { data, error } = await supabase.from("authors").select("*").order("id", { ascending: false });
      if (error) {
        document.getElementById("authorList").innerHTML = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: " + error.message;
        return;
      }
      if (!data || data.length === 0) {
        document.getElementById("authorList").innerHTML = "<p>ì•„ì§ ì…ë ¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      let html = "<h3>ì´ë¯¸ ì œì¶œí•œ ì €ì ëª©ë¡</h3><table><tr><th>ì„ íƒ</th><th>ì´ë¦„(í•œê¸€)</th><th>ì´ë¦„(ì˜ë¬¸)</th><th>ì†Œì†(í•œê¸€)</th><th>ì†Œì†(ì˜ë¬¸)</th><th>ORCID</th><th>ì´ë©”ì¼</th><th>ì„œëª…</th></tr>";
      data.forEach(row => {
        html += `<tr>
          <td><input type="checkbox" class="delete-check" value="${row.id}"></td>
          <td>${row.name_kr}</td>
          <td>${row.name_en}</td>
          <td>${row.affiliation_kr}</td>
          <td>${row.affiliation_en}</td>
          <td>${row.orcid || ""}</td>
          <td>${row.email}</td>
          <td><img src="${row.signature_url}" alt="signature"></td>
        </tr>`;
      });
      html += "</table>";

      document.getElementById("authorList").innerHTML = html;
    }

    async function deleteSelected() {
      const pw = document.getElementById("delete_pw").value;
      if (pw !== "1111") {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const checkboxes = document.querySelectorAll(".delete-check:checked");
      if (checkboxes.length === 0) {
        alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

      const { error } = await supabase.from("authors").delete().in("id", ids);

      if (error) {
        alert("ì‚­ì œ ì˜¤ë¥˜: " + error.message);
      } else {
        alert("ì„ íƒí•œ í•­ëª© ì‚­ì œ ì™„ë£Œ");
        loadAuthors();
      }
    }

    window.onload = loadAuthors;
  </script>
</body>
</html>





